#!/usr/bin/env ruby
require 'niconico'
require 'streamio-ffmpeg'
require 'optparse'
require 'yaml'
# also requires danmaku2ass

VIDEO_URL = /https?:\/\/(?:www\.|secure\.)?nicovideo\.jp\/watch\/((?:[a-z])+?[0-9]+)/

count = 5000

ARGV.options do |opts|
  opts.on("-c", "--count=val", Integer)   { |val| count = val }
  opts.parse!
end

url = ARGV.pop
raise "No URL given" unless url

if url =~ VIDEO_URL
  id = $1
end

raise "Could not parse ID" unless id

puts "Logging in..."

user_id = YAML.load_file(File.join(ENV['HOME'], "nv.yml"))
nv = Niconico.new(user_id["mail"], user_id["password"])
nv.login
v = nv.video(id)

name = "#{id}-#{v.title}".gsub("/","_")
filename = "#{name}.#{v.type}"


puts "Downloading #{id}..."
video = v.get_video
File.open("#{filename}", 'w') { |file| file.write(video) }
puts "Downloading comments..."
comments = v.get_comment(count)
File.open("#{name}.xml", 'w') { |file| file.write(comments) }

ff = FFMPEG::Movie.new("./#{filename}")

video_width = ff.width
video_height = ff.height

# I can't bring myself to rewrite this all over again...
`danmaku2ass \"#{name}.xml\" -s #{video_width}x#{video_height} -o \"#{name}.ass\"`

File.unlink("#{name}.xml")
