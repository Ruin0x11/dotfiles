#Panel scripts
![Preview](https://raw.github.com/tatou-tatou/Themes/master/Stendhal/Previews/panel.gif)

You will need [bar-aint-recursive](https://github.com/LemonBoy/bar) (for the panel) and [dzen](https://github.com/robm/dzen) (for the popups). Bspwm is *not* required, but you will have to rewrite chunks of the `panel` and `panel-monitor` scripts if you don't use it.

To have the same panel as me, put all the scripts in your $PATH. Sometimes, it might need a script I have put in my `~/.bin`, so look for it in the appropriate [place](https://github.com/tatou-tatou/dotfiles/tree/master/.bin).

There are a lot of scripts, so to keep things organized, I suggest you to make a dedicated location (`~/.panel` for example) where you would put all the panel related scripts. Of course, that directory must be added to your $PATH.

*Note: The BAR developer was lazy and haven't implemented a way to increase the maximum number of clickable areas dynamically. In the source code, there is a* `#define N 20` *somewhere,* **increase** *that value if you need more.*

###Bar fork
LemonBoy recently added support for other buttons than the left click. The way he did it was very frustrating, so [I did it another way](https://github.com/tatou-tatou/bar). The way I did it is very bad, but less useless. I will use my fork until he does it properly.

It allows you to do the following:

    %{A:left click:right click:} Some text %{A}

The old syntax (`%{A:left click:} Some text %{A}`) still works, but I removed the mostly useless `%{A<button>:command:}`.

I also merged a patch made by [this guy](https://github.com/pentla/bar):

    %{AW:left click:} Some text %{A}
    %{AW:left click:right click:} Some text %{A}

The above syntax will output the position of the clickable area after the command.

**I make an *extensive* use of those changes, so my full setup won't work if you are using the vanilla bar.**



#[Core](https://github.com/tatou-tatou/Themes/tree/master/Stendhal/Panel/Core) subdir
Without the content of this directory, nothing will work.

`panel` and `panel-skeleton` are mostly copy-pasted from the bspwm example panel scripts, with additional stuff and some removals.

##Start the panel
- To start everything, just launch `panel`, it will create the panel fifo and start bar.
- `panel-skeleton` interprets where to put each information that is piped to the fifo.
- `panel-settings` contains various settings, like the colors. It is loaded by the other scripts.

All the special characters (icons...) are custom made. You will need the *MonteCarloPanel* and *MonteCarloMedium* fonts from my [Monégasque](https://github.com/tatou-tatou/Monegasque) repo, or add the characters yourself to your font of choice.

If you want to use your own font with your own glyphs, just know that I had some issues with vertical alignment. I fixed it by duplicating my font and changing some of its properties (namely *SIZE*, *PIXEL_SIZE* and *FONT_DESCENT*) to align it properly. That's why I have both a *MonteCarloMedium* font and a *MonteCarloPanel* font, the later being dedicated to the panel.

##Workspaces
![Screenshot](https://raw.github.com/tatou-tatou/Themes/master/Stendhal/Previews/workspaces.gif)

The start menu is made by mygtkmenu. It appears when clicking on the blank space on the left of the workspace list.

You can easily add an icon or more space by editing the `start_icon` variable in `panel-settings`:

![Screenshot](https://raw.github.com/tatou-tatou/Themes/master/Stendhal/Previews/alternate_icon.png)

*Note: If you use bspwm and want to use a menu, you may want to take a look at [this](https://github.com/tatou-tatou/Themes/blob/master/Mousse)*

##Songs and system events
![Screenshot](https://raw.github.com/tatou-tatou/Themes/master/Stendhal/Previews/notstat.gif)

The music notification on the left of the panel is generated by *not-stat*, a shell script inspired by [statnot](https://github.com/halhen/statnot).

It will display a notification in the panel. If during three seconds there are no *new* notifications, the music will be displayed instead.

You call it like this:

    pkill not-stat ; not-stat <notification type> [message]

**Do not forget to kill the *not-stat* process before calling it, else the three seconds wait will not work properly!**

Of course, I could have written some lines at the beginning of the script to check if another instance was running, but the above method is much simpler, much saner and avoid all of the possible race conditions that could arise with any other method.

###Very simple music controls
![Label](https://raw.github.com/tatou-tatou/Themes/master/Stendhal/Previews/label-leftclick.gif)

- A left click on the label will toggle play/pause through mpc.
- A right click will open ncmpcpp.

The blue icon can toggle other things, read the *Monitor subdir* section.

*Note: this makes use of both left and right clicking, so it's* **not** *usable with vanilla bar! Refer to the first section.*

###Calling not-stat
####With mpdcron
On each song change or mpd event (like play/pause), [mpdcron](https://bbs.archlinux.org/viewtopic.php?pid=1354247) will execute the following:

    pkill not-stat ; not-stat Mu &

This will display the current song and its play/pause status in the panel.

####With sxhkd
It's also bound to keybinds, for example:

    XF86AudioRaiseVolume
        amixer set Master 1%+ ; pkill not-stat ; not-stat Vm

With those lines in your sxhkdrc, pressing the *XF86AudioRaiseVolume* key will raise the Master volume by 1 percent, display the new volume value and —after three seconds of inactivity— show the mpd status again.

Read my `sxhkdrc` if you want other examples. Aside from the obvious volume/brightness, I use not-stat to tell me the remaining battery time when I need it.

By not running `acpi` every `n` seconds, but only when I ask for it, it saves *some* battery time (I would say 20~30 minutes on my system). Avoiding such loops was the main goal when I made not-stat, and is always in my mind when I write scripts for my panel. A widget shouldn't update itself if the value it displays has not changed.

####With buttons
`not-stat` is also called by the scripts from the `Monitor` subdir when clicking on various buttons or when using the different sliders. *Read the next section.*


#[Monitor](https://github.com/tatou-tatou/Themes/tree/master/Stendhal/Panel/Monitor) subdir
If you are reading this, it's probably to use the scripts contained here. The scripts are for bar and dzen.

##Overview
For bar-aint-recursive itself,
- `panel-monitor` is called when you click on the blue icon. It currently provides controls for:
    * ~~Setting the PCM channel volume.~~ *(TODO: update .gif)*
    * Important desktop actions, like *rotate* and *flip*.
    * Setting the Master channel volume.
    * Setting the current keyboard layout.
    * Setting the screen brightness.
- `panel-music` is a simplified panel-monitor, dedicated to music controls. Those appears when you **right** click on the blue icon.

For the dzen popups and their sliders,
- `dslider`creates the dzen popup and the fifo used by the sliders.
- `dslider-content` creates the actual content of the popup (sliders).

`not-stat` is required to update the slider indicator position when the popup is opened and if you are using *keybinds* to change the volume/brightness (and not just clicking on the slider). If you want to know why, look at what happens when you call `not-stat` with the -d, -v or -V argument.

*Note: All of the above scripts rely heavily on the x-position patch to calculate where the popup should appear. They also use both left and right clicking. For those two reasons they are* **not** *usable with vanilla bar. Refer to the first section.*

##Panel-monitor
![Left click](https://raw.github.com/tatou-tatou/Themes/master/Stendhal/Previews/icon-leftclick.gif)

All of this is generated by `panel-monitor` and the two dzen scripts. It appears when you click on the `not-stat` blue icon.

###Desktop controls
![Desktop](https://raw.github.com/tatou-tatou/Themes/master/Mousse/Previews/desktop-controls.png)

Provides controls for rotating and flipping the tree. You can read more about why I put shortcuts for those controls and not others [here](https://github.com/tatou-tatou/Themes/tree/master/Mousse#bspwmmenu).

I configured mouse controls for all WM-related actions, if you are interested I suggest you to read the [Mousse theme README](https://github.com/tatou-tatou/Themes/tree/master/Mousse). Some are barely ergonomic, but I work on that.

###Volume controls
Should work out of the box. I just use the CLI tools that come with ALSA to get and change the Master volume.

###Keyboard layouts
Obviously, if you want to use this you will have to adapt it to your setup. It uses `setxkbmap`, so reading its man page would be a good start.

First, you will want the `layoutCmd` variable to fit your model of keyboard.

The `Fr Us` in `for layout in Fr Us` are what will be displayed in the panel. You must use valid layout names, but it won't matter if they are upper-case (the `${layout,,}` in `layoutCmd` will make them lower case anyway).

Don't forget to configure `not-stat` as well. Just add a variable named after the layout you use and make it contain the message you want to be displayed when you switch to that layout.

###Brightness controls
To draw the slider, it reads the current screen brightness value in:

    /sys/<...>/backlight/<...>/brightness

And its max value in:

    /sys/<...>/backlight/<...>/max_brightness

The path to those files probably won't be the same on our respective systems, so **edit** them in `panel-settings`.

The same for [the script I use](https://github.com/tatou-tatou/dotfiles/blob/master/.bin/mbp_backlight) to change the screen brightness. If you want to use it, you will need to adapt it to your system. It's not required of course.



##Panel-music
A **right** click on the blue button will spawn `panel-music`:

![Right click](https://raw.github.com/tatou-tatou/Themes/master/Stendhal/Previews/icon-rightclick.gif)

- A **right** click on the then created pink `Mu` button will let you toggle *repeat*, *random*, *single* and *consume* in mpd.
- A **left** click will either spawn `panel-monitor` or take you back to the normal music controls (if you were in the *repeat, random, etc* mode).

`panel-music` uses a script from my ~/.bin called `mpc-script`. You might want to replace any occurrence of `mpc-script prev` by `mpc prev` (or just grab the currently unfinished `mpc-script` from my `~/.bin`). The mpc-script doesn't do much, I just made it to combine both `mpc prev` (if you are at the beginning of the song) and `mpc seek 0%` (if you are not) in a single button.

The dzen popup provides shortcuts to launch [mpdviz](https://github.com/neeee/mpdviz), *ncmpcpp* and my [coverart](https://github.com/tatou-tatou/dotfiles/blob/master/.bin/coverart) script.

*Note: the new gif API broke `meh`, making the coverart script unusable right now. It was not that good anyway.*

##Make your own stuff!
I tried to make the code as easy to edit as possible. Unless otherwise specified, all of the following instructions are for the `panel-monitor` script.

###Removing a button
If you think a button is useless, just remove it from the

    for Button in Vl Kb Sc

You can then remove the associated code from the `case` statement and the `Vl="<button title>"`-like variable.

You may also want to remove the unused lines from `dslider` and `dslider-content`.

If you removed a button that has a slider, you may want to edit `not-stat` as well.

###Changing a button name
In `panel-monitor`, you have this at the beginning:

    Vl="Vl"
    Kb="Kb"
    Wm="Wm"
    Sc="Sc"

The syntax is simply `<Button variable>="<Title that will be displayed>"`. Edit the title to your heart content, it can be as long as you want. You can use icon glyphs too, of course.

The (displayed) button title can be as long as you want, but if you use something longer than two characters, you will have to adjust how `dslider` calculates the popup position.

###Adding a button
Create a variable like explained above:

    <Variable name>="<Title displayed in the panel>"

**IMPORTANT:** Contrary to the button title, the variable name *must* be **two characters long**!

Then just add the two character variable name to

    for Button in Wm Vl Kb Sc

To configure what appears when you click on it, add another condition to the `case`. That condition must create content for the `message` variable.

If your button has a slider, do not forget to **add** its name to the `sliderlist` variable (the order does not matter)!

###Creating your own sliders
The most important part is to understand how the popup calculates where it should appear.

In practice, you only have to add two lines in `dslider`, one to adjust the coordinates if a button was clicked while *your* button was already focused:

    <button title>) xpos=$(($xpos - <width of the button label>)) ;;

And one to adjust the coordinates when it's the *arrow* that was clicked:

    <button title>) xpos=$(($xpos - <distance to the arrow>)) ;;

The code is heavily commented, the place where to insert those lines will be obvious to you.

Edit `dslider-content` to actually create your own slider. You have to provide:
- A way to get the *current* value.
- The *max* value or a way to get it.
- A command to *change* the current value to a specific value.

Where/how to add those in `dslider-content` will be obvious.


#[Lists](https://github.com/tatou-tatou/Themes/tree/master/Stendhal/Panel/Lists) subdir
The content of that directory is only half-made and subject to a *lot* of future changes.

##To-watch list
![Torrents](https://raw.github.com/tatou-tatou/Themes/master/Stendhal/Previews/torrents.gif)

- `panel-torrents` displays the number of unwatched items in the panel.
    - Clicking on that number spawns the popup (by launching `dzen-menu`).
    - Clicking a second time will close the popup.
    - A right click will open transmission-remote-cli through my [run-or-raise](https://github.com/tatou-tatou/dotfiles/blob/master/.bin/run-or-raise) script.
- `dzen-menu` creates the popup. Right clicking on the popup will close it.
- `dzen-menu-content` creates the content of the popup from a text file acting as a list.

[This](https://github.com/tatou-tatou/dotfiles/blob/master/.bin/notify-torrent-done) script (called by transmission-daemon when a torrent is finished), will add the filename at the end of the text file.

I use **rssdler** to automatically fetch torrents from rss feeds and to send me a notification when a new .torrent file is about to be downloaded.
I know rssdler can be run as a daemon, but I use `cron` and `rssdler -r` instead.

In the popup, clicking on the [X] will remove the associated line from the list.

Clicking on a file name will send it to **xdg-open**, so it should work with any file type. I chose to use xdg-open only out of laziness, but I would enjoy more control, especially for things like compressed files (I would like to use mcomix if it's a comic, but if it's not then opening it in a file manager would be a better solution).

The script assumes the file is inside your Torrents folder, if it's anywhere else it won't work.

For some reason, I cannot make it so that arrow keys can be used to navigate the list. I'm almost sure it's possible with dzen, so if someone have a solution, I'm very interested.

######To do
- Use something else than xdg-open.
- Make it work if the file is elsewhere than in the Torrents folder.
- Navigating with arrow keys.
- Rewrite a good part of the code as it's a hackish mess, especially what I do to "clean" after the popup closed, no matter *how* it was closed. I think I have found a partial solution (that I already use for the "slider" dzen popup) though. The script also contains remains from other scripts and lacks a good part of its end (it lacks support for the todo list).

##Todo list
It works exactly like the to watch list and the mounted devices list. It's unfinished and I haven't included it fully (yet), but it uses `dzen-menu` and `dzen-menu-content` too (like the to watch list).

It depends on `remind` to automatically add new tasks, or automatically remove the tasks that are out-of-date and cannot be done anymore.

##Mounted devices list
I haven't included it here. It's in my dotfiles repo though, and it works pretty well.

![Mountlist](https://raw.github.com/tatou-tatou/Themes/master/Stendhal/Previews/mountlist.gif)

Appears when you do a right click on the date. It lists mounted devices:
- Clicking on their name will open their mountpoint in the file manager.
- Clicking on the [X] next to their name will unmount them.

It uses `udevil`.

I use devmon to automount. I like devmon a lot, but udevil and it don't blend well with other programs (except [those written by the same dev](http://ignorantguru.github.io/spacefm/), obviously). I'm happy with devmon, so I don't really care though.

*Note:* This is the functional equivalent of one of my [dmenu scripts](https://github.com/tatou-tatou/dotfiles/blob/master/.bin/dmenu_umount), except the dmenu script is obviously much simpler and cleaner.

##Hidden windows list
![Hiddenlist](https://raw.github.com/tatou-tatou/Themes/master/Stendhal/Previews/hide.gif)

I made the rough (but working) sketch of a "**minimize**" script. It's called `whid` and can be used with dmenu or dzen. It's nothing but a draft, it needs more ricing to look good and work seamlessly.

It can integrate itself with the panel too:
- The number of currently hidden windows is displayed in the top right corner.
- Clicking on that number will spawn the list of hidden windows in a dzen menu.

To hide the focused window (bind it to something with sxhkd and/or add it to the menu from [Mousse](https://github.com/tatou-tatou/Themes/tree/master/Mousse#bspwmmenu)):

    whid hide

To spawn the list of hidden windows:

    whid dmenu

or

    whid dzen

Bind `whid dmenu` to sxhkd. `whid dzen` is only to provide a list for the panel.

*Note: I do not actually minimize the windows, I map and unmap them!*

*Note 2: if you just want the map/unmap without the panel integration, a LARGE part of the script can be edited out. A simpler version is in my ~/.bin (it's called `whid-nopanel`)*



#[Misc](https://github.com/tatou-tatou/Themes/tree/master/Stendhal/Panel/Misc) subdir
##Mails
![Mails](https://raw.github.com/tatou-tatou/Themes/master/Stendhal/Previews/panel-mail.gif)

- In the panel, you can **click** on the icon to hide the number of unread mails.
- A **right** click will open mutt (or focus it if it's already opened) through my [run-or-raise script](https://github.com/tatou-tatou/dotfiles/blob/master/.bin/run-or-raise).

`panel-mail` is called by cron after it fetches mails with `getmail`:

    0 * * * * /usr/bin/getmail --rcfile mailbox1 --rcfile mailbox2 ; /home/tatou/.bin/panel-mail

You could also make an alias so it's called when you close mutt, that way the number of unread mails will update:

    alias mutt='mutt ; panel-mail'

Alternatively, you can make a very small script like [this one](https://github.com/tatou-tatou/dotfiles/blob/master/.bin/mutt-panel) and call it instead of mutt when you want to open your mail client (I combine both methods, the script is only used by my run-or-raise script).

Technically, you are not forced to use mutt, the above script would work with any mail client that supports the maildir format.

##Calendar
Found it on Twily's [website](http://www.twily.info) and tweaked it a little. It's the `dcal` script.

![Calendar](https://raw.github.com/tatou-tatou/Themes/master/Stendhal/Previews/dcal.gif)

If you click on the date in the panel, the calendar will pop. If you click **again** on the date, it will disappear. A click or right click on the popup will close it.
